#!/bin/bash

SNAPSHOT_DIRECTORY=packages/workflow-core/test/integration/__image_snapshots__
BRANCH_PREFIX=travis-update-snapshot

# Exit early if there are no changes in the snapshot directory
if [[ -z $(git status $SNAPSHOT_DIRECTORY -s) ]]  ; then
  echo "No snapshots to update"
  exit 0
fi

# Determine branch names
if [[ -z $TRAVIS_PULL_REQUEST_BRANCH ]]; then
  CURRENT_BRANCH=$TRAVIS_BRANCH
else
  CURRENT_BRANCH=$TRAVIS_PULL_REQUEST_BRANCH
fi

if [[ $CURRENT_BRANCH == "$BRANCH_PREFIX"* ]]; then
  echo "The branch is a snapshot update generated by this script"
  echo "This usually occurs due to a bug in the script"
  echo "Exiting to avoid infinite build"
  exit 0
fi

# Save state (restored at the end of the script)
git stash -u

SNAPSHOT_BRANCH="$BRANCH_PREFIX-$TRAVIS_JOB_NUMBER/$CURRENT_BRANCH"

# Create branch
git checkout -b $SNAPSHOT_BRANCH

# Run integration tests and update new snapshots
yarn jest -u integration

# Setup git credentials
git config --global user.email "travis@travis-ci.org"
git config --global user.name "Travis CI"

# Setup github remote
git remote set-url origin https://${GH_TOKEN}@github.com/havardh/workflow.git

# Commit and push the updated snapshots to origin
git add $SNAPSHOT_DIRECTORY/*
git commit -m 'test: update snapshot for osx

This commit was generated by /script/travis-update-snapshot'
git push -u origin $SNAPSHOT_BRANCH

# Restore state from before execution of this script
git checkout $CURRENT_BRANCH
git stash pop
